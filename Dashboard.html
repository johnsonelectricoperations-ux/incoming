<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ëŒ€ì‹œë³´ë“œ - ê²€ì‚¬ì„±ì ì„œ ê´€ë¦¬</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f5f7fa;
      color: #333;
    }
    
    /* í—¤ë” */
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
    }
    
    .header-title h1 {
      font-size: 24px;
      margin-bottom: 5px;
    }
    
    .header-title p {
      font-size: 14px;
      opacity: 0.9;
    }
    
    .header-actions {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      text-decoration: none;
      display: inline-block;
    }
    
    .btn-white {
      background: white;
      color: #667eea;
    }
    
    .btn-white:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(255,255,255,0.3);
    }
    
    .btn-outline {
      background: transparent;
      color: white;
      border: 2px solid white;
    }
    
    .btn-outline:hover {
      background: white;
      color: #667eea;
    }
    
    /* ë©”ì¸ ì»¨í…ì¸  */
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 30px 20px;
    }
    
    /* ë‚´ë¹„ê²Œì´ì…˜ */
    .nav-menu {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 30px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }
    
    .nav-btn {
      padding: 12px 24px;
      background: #f0f4ff;
      color: #667eea;
      border: 2px solid transparent;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .nav-btn:hover {
      background: #667eea;
      color: white;
      transform: translateY(-2px);
    }
    
    .nav-btn.active {
      background: #667eea;
      color: white;
      border-color: #667eea;
    }
    
    /* í†µê³„ ì¹´ë“œ */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      transition: transform 0.3s, box-shadow 0.3s;
    }
    
    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    }
    
    .stat-icon {
      font-size: 36px;
      margin-bottom: 10px;
    }
    
    .stat-label {
      color: #666;
      font-size: 14px;
      margin-bottom: 8px;
    }
    
    .stat-value {
      font-size: 32px;
      font-weight: bold;
      color: #333;
    }
    
    .stat-card.primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .stat-card.primary .stat-label {
      color: rgba(255,255,255,0.9);
    }
    
    .stat-card.primary .stat-value {
      color: white;
    }
    
    .stat-card.success {
      border-left: 4px solid #4caf50;
    }
    
    .stat-card.info {
      border-left: 4px solid #2196f3;
    }
    
    /* ìµœê·¼ ë°ì´í„° í…Œì´ë¸” */
    .section {
      background: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      margin-bottom: 30px;
    }
    
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #f0f0f0;
    }
    
    .section-title {
      font-size: 20px;
      font-weight: bold;
      color: #333;
    }
    
    .table-responsive {
      overflow-x: auto;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    thead {
      background-color: #f8f9fa;
    }
    
    th {
      padding: 12px;
      text-align: left;
      font-weight: 600;
      color: #555;
      border-bottom: 2px solid #e0e0e0;
      font-size: 14px;
    }
    
    td {
      padding: 12px;
      border-bottom: 1px solid #f0f0f0;
      font-size: 14px;
    }
    
    tbody tr:hover {
      background-color: #f8f9fa;
    }
    
    .empty-state {
      text-align: center;
      padding: 40px;
      color: #999;
    }
    
    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 15px;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    
    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* ë°˜ì‘í˜• */
    @media (max-width: 768px) {
      .header-content {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
      }
      
      .nav-menu {
        flex-direction: column;
      }
      
      .nav-btn {
        width: 100%;
      }
      
      table {
        font-size: 12px;
      }
      
      th, td {
        padding: 8px;
      }
    }
  </style>
</head>
<body>
  <!-- í—¤ë” -->
  <div class="header">
    <div class="header-content">
      <div class="header-title">
        <h1>í˜‘ë ¥ì‚¬ ìˆ˜ì…ê²€ì‚¬ ê´€ë¦¬</h1>
        <p id="userInfo">ë¡œë”© ì¤‘...</p>
      </div>
      <div class="header-actions">
        <button class="btn btn-outline" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
      </div>
    </div>
  </div>
  
  <!-- ë©”ì¸ ì»¨í…ì¸  -->
  <div class="container">
    <!-- ë‚´ë¹„ê²Œì´ì…˜ ë©”ë‰´ -->
    <?!= include('Navigation') ?>
    
    <!-- í†µê³„ ì¹´ë“œ -->
    <div class="stats-grid">
      <div class="stat-card primary">
        <div class="stat-icon">ğŸ“¦</div>
        <div class="stat-label">ì „ì²´ ë“±ë¡ ê±´ìˆ˜</div>
        <div class="stat-value" id="totalCount">-</div>
      </div>
      
      <div class="stat-card success">
        <div class="stat-icon">ğŸ“…</div>
        <div class="stat-label">ì˜¤ëŠ˜ ë“±ë¡ ê±´ìˆ˜</div>
        <div class="stat-value" id="todayCount">-</div>
      </div>
      
      <div class="stat-card info">
        <div class="stat-icon">ğŸ“†</div>
        <div class="stat-label">ì´ë²ˆë‹¬ ë“±ë¡ ê±´ìˆ˜</div>
        <div class="stat-value" id="monthCount">-</div>
      </div>
    </div>
    
    <!-- ìµœê·¼ ë“±ë¡ ë°ì´í„° -->
    <div class="section">
      <div class="section-header">
        <h2 class="section-title">ìµœê·¼ ë“±ë¡ ë°ì´í„°</h2>
        <button class="btn btn-white" onclick="goToPage('history')">ì „ì²´ ë³´ê¸° â†’</button>
      </div>
      
      <div id="recentDataContainer">
        <div class="loading">
          <div class="spinner"></div>
          <p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Item ê´€ë¦¬ ëª¨ë‹¬ -->
  <div id="itemModal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
    <div class="modal-content" style="background-color: white; margin: 50px auto; padding: 0; border-radius: 12px; width: 90%; max-width: 1200px; max-height: 80vh; overflow-y: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
      <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px 25px; border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; align-items: center;">
        <h3 style="font-size: 20px; font-weight: 600; margin: 0;">ğŸ“¦ Item ê´€ë¦¬</h3>
        <span onclick="closeItemModal()" style="color: white; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
      </div>

      <div style="padding: 25px;">
        <!-- ê²€ìƒ‰ í•„í„° -->
        <div style="display: flex; gap: 10px; margin-bottom: 20px; align-items: flex-end;">
          <div style="flex: 1;">
            <label style="display: block; font-weight: 600; margin-bottom: 5px; font-size: 14px;">ì—…ì²´ëª…</label>
            <select id="searchItemCompany" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
              <option value="">ì „ì²´</option>
            </select>
          </div>
          <div style="flex: 1;">
            <label style="display: block; font-weight: 600; margin-bottom: 5px; font-size: 14px;">TM-NO</label>
            <input type="text" id="searchItemTmNo" placeholder="TM-NO ê²€ìƒ‰" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
          </div>
          <button onclick="searchItems()" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer;">ğŸ” ê²€ìƒ‰</button>
          <button onclick="clearItemSearch()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer;">â†» ì´ˆê¸°í™”</button>
          <button onclick="showItemAddModal()" style="padding: 10px 20px; background: #4caf50; color: white; border: none; border-radius: 8px; cursor: pointer;">â• ì¶”ê°€</button>
        </div>

        <!-- Item ëª©ë¡ -->
        <div id="itemListContainer">
          <div style="text-align: center; padding: 60px 20px; color: #999;">
            <div style="font-size: 64px; margin-bottom: 20px;">ğŸ“­</div>
            <p>ë“±ë¡ëœ Itemì´ ì—†ìŠµë‹ˆë‹¤.</p>
          </div>
        </div>
      </div>

      <div style="padding: 20px 25px; border-top: 1px solid #e0e0e0; text-align: right;">
        <button onclick="closeItemModal()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer;">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <!-- Item ì¶”ê°€/ìˆ˜ì • ëª¨ë‹¬ -->
  <div id="itemEditModal" class="modal" style="display: none; position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
    <div class="modal-content" style="background-color: white; margin: 100px auto; padding: 0; border-radius: 12px; width: 90%; max-width: 600px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
      <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px 25px; border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; align-items: center;">
        <h3 id="itemModalTitle" style="font-size: 20px; font-weight: 600; margin: 0;">Item ì¶”ê°€</h3>
        <span onclick="closeItemEditModal()" style="color: white; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
      </div>

      <div style="padding: 25px;">
        <input type="hidden" id="itemRowIndex">

        <div style="margin-bottom: 20px;">
          <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #333; font-size: 14px;">TM-NO</label>
          <input type="text" id="itemTmNo" placeholder="TM-NOë¥¼ ì…ë ¥í•˜ì„¸ìš”" style="width: 100%; padding: 10px 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
        </div>

        <div style="margin-bottom: 20px;">
          <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #333; font-size: 14px;">ì œí’ˆëª…</label>
          <input type="text" id="itemProductName" placeholder="ì œí’ˆëª…ì„ ì…ë ¥í•˜ì„¸ìš”" style="width: 100%; padding: 10px 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
        </div>

        <div style="margin-bottom: 20px;">
          <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #333; font-size: 14px;">ì—…ì²´ëª…</label>
          <select id="itemCompanyName" style="width: 100%; padding: 10px 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
            <option value="">ì—…ì²´ëª…ì„ ì„ íƒí•˜ì„¸ìš”</option>
          </select>
        </div>

        <div style="margin-bottom: 20px;">
          <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #333; font-size: 14px;">ê²€ì‚¬í˜•íƒœ</label>
          <select id="itemInspectionType" style="width: 100%; padding: 10px 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
            <option value="">ê²€ì‚¬í˜•íƒœë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
            <option value="ê²€ì‚¬">ê²€ì‚¬</option>
            <option value="ë¬´ê²€ì‚¬">ë¬´ê²€ì‚¬</option>
          </select>
        </div>
      </div>

      <div style="padding: 20px 25px; border-top: 1px solid #e0e0e0; display: flex; justify-content: flex-end; gap: 10px;">
        <button onclick="closeItemEditModal()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer;">ì·¨ì†Œ</button>
        <button onclick="saveItem()" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer;">ì €ì¥</button>
      </div>
    </div>
  </div>

  <!-- ê²€ì‚¬ê·œê²© ì¶”ê°€/ìˆ˜ì • ëª¨ë‹¬ -->
  <div id="specModal" class="modal" style="display: none; position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); overflow: auto;">
    <div class="modal-content" style="background-color: white; margin: 50px auto; padding: 0; border-radius: 12px; width: 95%; max-width: 1000px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); max-height: 90vh; overflow: hidden; display: flex; flex-direction: column;">
      <div style="background: linear-gradient(135deg, #e69138 0%, #cc7722 100%); color: white; padding: 20px 25px; border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; align-items: center;">
        <h3 id="specModalTitle" style="font-size: 20px; font-weight: 600; margin: 0;">ê²€ì‚¬ ê·œê²© ì¶”ê°€</h3>
        <span onclick="closeSpecModal()" style="color: white; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
      </div>

      <div style="padding: 25px; overflow-y: auto; flex: 1;">
        <div style="margin-bottom: 20px;">
          <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #333; font-size: 14px;">TM-NO</label>
          <input type="text" id="specTmNo" readonly style="width: 100%; padding: 10px 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; background-color: #f5f5f5;">
        </div>

        <div style="margin-bottom: 20px;">
          <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #333; font-size: 14px;">ì œí’ˆëª…</label>
          <input type="text" id="specProductName" readonly style="width: 100%; padding: 10px 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; background-color: #f5f5f5;">
        </div>

        <div style="margin-bottom: 20px;">
          <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #333; font-size: 14px;">ì—…ì²´ëª…</label>
          <input type="text" id="specCompanyName" readonly style="width: 100%; padding: 10px 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; background-color: #f5f5f5;">
        </div>

        <div style="margin-bottom: 20px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <label style="font-weight: 600; color: #333; font-size: 14px;">ê²€ì‚¬ í•­ëª©</label>
            <button onclick="addSpecRow()" style="padding: 8px 16px; background: #e69138; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px;">â• ê²€ì‚¬í•­ëª© ì¶”ê°€</button>
          </div>
          <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; border: 1px solid #ddd;">
              <thead>
                <tr style="background-color: #f8f9fa;">
                  <th style="padding: 10px; border: 1px solid #ddd; text-align: left; font-size: 13px;">ê²€ì‚¬í•­ëª©</th>
                  <th style="padding: 10px; border: 1px solid #ddd; text-align: left; font-size: 13px;">ì¸¡ì •ë°©ë²•</th>
                  <th style="padding: 10px; border: 1px solid #ddd; text-align: left; font-size: 13px;">ê·œê²©í•˜í•œ</th>
                  <th style="padding: 10px; border: 1px solid #ddd; text-align: left; font-size: 13px;">ê·œê²©ìƒí•œ</th>
                  <th style="padding: 10px; border: 1px solid #ddd; text-align: left; font-size: 13px;">ì‹œë£Œìˆ˜</th>
                  <th style="padding: 10px; border: 1px solid #ddd; text-align: center; width: 80px; font-size: 13px;">ì‚­ì œ</th>
                </tr>
              </thead>
              <tbody id="specItemsBody">
                <!-- ê²€ì‚¬í•­ëª© í–‰ë“¤ì´ ì—¬ê¸°ì— ì¶”ê°€ë©ë‹ˆë‹¤ -->
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div style="padding: 20px 25px; border-top: 1px solid #e0e0e0; display: flex; justify-content: flex-end; gap: 10px;">
        <button onclick="closeSpecModal()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer;">ì·¨ì†Œ</button>
        <button onclick="saveItemSpecs()" style="padding: 10px 20px; background: #e69138; color: white; border: none; border-radius: 8px; cursor: pointer;">ì €ì¥</button>
      </div>
    </div>
  </div>

  <script>
    // ===== í† í° ê´€ë¦¬ =====
    let sessionToken = null;
    let currentUser = null; // í˜„ì¬ ë¡œê·¸ì¸ ì‚¬ìš©ì ì •ë³´ ì €ì¥

    // í† í° ì´ˆê¸°í™” (ì„œë²„ì—ì„œ ì „ë‹¬ë°›ì€ í† í° ë˜ëŠ” sessionStorageì—ì„œ)
    function initToken() {
      // ì„œë²„ì—ì„œ ì „ë‹¬ë°›ì€ í† í° (í…œí”Œë¦¿ ë³€ìˆ˜)
      const serverToken = '<?!= token ?>';

      if (serverToken && serverToken !== 'undefined' && serverToken.length > 10) {
        sessionToken = serverToken;
        sessionStorage.setItem('sessionToken', serverToken);
        console.log('í† í° ì´ˆê¸°í™” ì™„ë£Œ (ì„œë²„ì—ì„œ ì „ë‹¬)');
      } else {
        // sessionStorageì—ì„œ í† í° ê°€ì ¸ì˜¤ê¸°
        sessionToken = sessionStorage.getItem('sessionToken');
        console.log('í† í° ì´ˆê¸°í™” ì™„ë£Œ (sessionStorage)');
      }

      if (!sessionToken) {
        console.error('í† í° ì—†ìŒ - ë¡œê·¸ì¸ í•„ìš”');
        redirectToLogin();
      }

      return sessionToken;
    }

    // ì•ˆì „í•œ í˜ì´ì§€ ì´ë™ (iframe ìƒŒë“œë°•ìŠ¤ í˜¸í™˜)
    function safeNavigate(url, params) {
      // Query string ìƒì„±
      let fullUrl = url;
      if (params) {
        const queryString = Object.keys(params)
          .map(key => encodeURIComponent(key) + '=' + encodeURIComponent(params[key]))
          .join('&');
        fullUrl = url + '?' + queryString;
      }

      // window.top.location.hrefë¡œ ì§ì ‘ ë„¤ë¹„ê²Œì´ì…˜
      // form.submit()ì€ ì‚¬ìš©ì ì œìŠ¤ì²˜ë¡œ ê°„ì£¼ë˜ì§€ ì•Šì•„ sandbox ì—ëŸ¬ ë°œìƒ
      window.top.location.href = fullUrl;
    }

    // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
    function redirectToLogin() {
      sessionStorage.removeItem('sessionToken');
      safeNavigate('https://script.google.com/macros/s/AKfycbxQB4616RO3VVmBmKV4oiuyL0TM5FXmXRG6qWSxqBMfKg8MzfoTt9p0AWPbZbUdUtvs9g/exec', null);
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
    window.onload = function() {
      // í† í° ì´ˆê¸°í™”
      initToken();

      // ë¨¼ì € ì‚¬ìš©ì ì •ë³´ ë¡œë“œ (ì„¸ì…˜ í™•ì¸)
      loadUserInfo();

      // ì•½ê°„ì˜ ì§€ì—° í›„ ëŒ€ì‹œë³´ë“œ ë°ì´í„° ë¡œë“œ
      setTimeout(function() {
        loadDashboardData();
      }, 500);
    };

    // ë„¤ë¹„ê²Œì´ì…˜ ì´ˆê¸°í™” í•¨ìˆ˜
    function initNavigation(currentPage, userRole) {
      // í˜„ì¬ í˜ì´ì§€ì— active í´ë˜ìŠ¤ ì¶”ê°€
      const navButtons = {
        'dashboard': 'navDashboard',
        'entry': 'navEntry',
        'history': 'navHistory',
        'certificate': 'navCertificate'
      };

      if (navButtons[currentPage]) {
        const btn = document.getElementById(navButtons[currentPage]);
        if (btn) {
          btn.classList.add('active');
        }
      }

      // Item ë“±ë¡ ë²„íŠ¼ì€ ëŒ€ì‹œë³´ë“œì—ì„œë§Œ í‘œì‹œ
      const itemBtn = document.getElementById('navItem');
      if (itemBtn) {
        itemBtn.style.display = (currentPage === 'dashboard') ? 'inline-block' : 'none';
      }

      // ì‚¬ìš©ì ê´€ë¦¬ ë²„íŠ¼ì€ ê´€ë¦¬ìë§Œ í‘œì‹œ
      const usersBtn = document.getElementById('navUsers');
      if (usersBtn) {
        usersBtn.style.display = (userRole === 'ê´€ë¦¬ì') ? 'inline-block' : 'none';
      }

      // ë„¤ë¹„ê²Œì´ì…˜ ë©”ë‰´ í‘œì‹œ (ë¶€ë“œëŸ¬ìš´ fade-in íš¨ê³¼)
      const navMenu = document.getElementById('navMenu');
      if (navMenu) {
        navMenu.style.opacity = '1';
      }
    }

    // Item í´ë¦­ í•¸ë“¤ëŸ¬
    function handleItemClick() {
      // Dashboard í˜ì´ì§€ì—ì„œëŠ” ëª¨ë‹¬ ì—´ê¸°
      if (typeof showItemManagementModal === 'function') {
        showItemManagementModal();
      } else {
        // ë‹¤ë¥¸ í˜ì´ì§€ì—ì„œëŠ” Dashboardë¡œ ì´ë™
        goToPage('dashboard');
      }
    }

    // ì‚¬ìš©ì ì •ë³´ ë¡œë“œ
    function loadUserInfo() {
      google.script.run
        .withSuccessHandler(function(response) {
          console.log('ì‚¬ìš©ì ì •ë³´ ì‘ë‹µ:', response);

          if (response && response.success) {
            const user = response.user;
            currentUser = user; // ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
            document.getElementById('userInfo').textContent =
              `${user.companyName} | ${user.name} (${user.role})`;

            // ë„¤ë¹„ê²Œì´ì…˜ ì´ˆê¸°í™”
            initNavigation('dashboard', user.role);
          } else {
            // ì„¸ì…˜ ì—†ìœ¼ë©´ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ
            console.error('ì„¸ì…˜ ì—†ìŒ - ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™');
            redirectToLogin();
          }
        })
        .withFailureHandler(function(error) {
          console.error('ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
        })
        .getCurrentUserByToken(sessionToken);
    }

    // ëŒ€ì‹œë³´ë“œ ë°ì´í„° ë¡œë“œ
    function loadDashboardData() {
      console.log('getDashboardStats í˜¸ì¶œ ì‹œì‘...');

      google.script.run
        .withSuccessHandler(function(response) {
          console.log('getDashboardStats ì‘ë‹µ:', response);
          console.log('ì‘ë‹µ íƒ€ì…:', typeof response);
          console.log('ì‘ë‹µ null ì²´í¬:', response === null);
          
          if (!response) {
            console.error('ì„œë²„ ì‘ë‹µì´ nullì…ë‹ˆë‹¤.');
            showError('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
            return;
          }
          
          if (response.success) {
            const stats = response.stats;
            console.log('í†µê³„ ë°ì´í„°:', stats);
            
            // í†µê³„ ì—…ë°ì´íŠ¸
            document.getElementById('totalCount').textContent = stats.totalCount || 0;
            document.getElementById('todayCount').textContent = stats.todayCount || 0;
            document.getElementById('monthCount').textContent = stats.thisMonthCount || 0;
            
            // ìµœê·¼ ë°ì´í„° í…Œì´ë¸” ìƒì„±
            displayRecentData(stats.recentData || []);
          } else {
            showError(response.message || 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          }
        })
        .withFailureHandler(function(error) {
          console.error('ëŒ€ì‹œë³´ë“œ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
          console.error('ì—ëŸ¬ ë©”ì‹œì§€:', error.message);
          console.error('ì—ëŸ¬ ìŠ¤íƒ:', error.stack);
          showError('ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
        })
        .getDashboardStats(sessionToken);
    }
        
    // ìµœê·¼ ë°ì´í„° í‘œì‹œ
    function displayRecentData(data) {
      const container = document.getElementById('recentDataContainer');
      
      if (!data || data.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ“­</div>
            <p>ë“±ë¡ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
          </div>
        `;
        return;
      }
      
      let html = `
        <div class="table-responsive">
          <table>
            <thead>
              <tr>
                <th>ì—…ì²´ëª…</th>
                <th>ì…ê³ ë‚ ì§œ</th>
                <th>ì…ê³ ì‹œê°„</th>
                <th>TM-NO</th>
                <th>ì œí’ˆëª…</th>
                <th>ìˆ˜ëŸ‰</th>
              </tr>
            </thead>
            <tbody>
      `;

      data.forEach(function(item) {
        html += `
          <tr>
            <td>${item.companyName}</td>
            <td>${item.date}</td>
            <td>${item.time}</td>
            <td>${item.tmNo}</td>
            <td>${item.productName}</td>
            <td>${item.quantity}</td>
          </tr>
        `;
      });
      
      html += `
            </tbody>
          </table>
        </div>
      `;
      
      container.innerHTML = html;
    }
    
    // ì—ëŸ¬ í‘œì‹œ
    function showError(message) {
      const container = document.getElementById('recentDataContainer');
      container.innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">âš ï¸</div>
          <p>${message}</p>
        </div>
      `;
    }
    
    // í˜ì´ì§€ ì´ë™
    function goToPage(page) {
      const token = sessionStorage.getItem('sessionToken');
      const webAppUrl = '<?= getWebAppUrl() ?>';
      safeNavigate(webAppUrl, {
        'page': page,
        'token': token,
        't': Date.now()
      });
    }

    // ë¡œê·¸ì•„ì›ƒ
    function logout() {
      if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        const token = sessionStorage.getItem('sessionToken');
        const webAppUrl = '<?= getWebAppUrl() ?>';
        google.script.run
          .withSuccessHandler(function() {
            sessionStorage.removeItem('sessionToken');
            safeNavigate(webAppUrl, null);
          })
          .withFailureHandler(function(error) {
            console.error('ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨:', error);
            sessionStorage.removeItem('sessionToken');
            safeNavigate(webAppUrl, null);
          })
          .logoutWithToken(token);
      }
    }

    // ========== Item ê´€ë¦¬ í•¨ìˆ˜ë“¤ ==========

    // Item ê´€ë¦¬ ëª¨ë‹¬ ì—´ê¸°
    function showItemManagementModal() {
      document.getElementById('itemModal').style.display = 'block';
      loadItemCompanyList();
      loadItemSpecCounts(); // ê·œê²© ë“±ë¡ ìƒíƒœ ë¡œë“œ
      loadItems();
    }

    // Item ê´€ë¦¬ ëª¨ë‹¬ ë‹«ê¸°
    function closeItemModal() {
      document.getElementById('itemModal').style.display = 'none';
    }

    // Item ì—…ì²´ëª… ëª©ë¡ ë¡œë“œ (ê²€ìƒ‰ìš©)
    function loadItemCompanyList() {
      google.script.run
        .withSuccessHandler(function(response) {
          if (response.success && response.companies) {
            const select = document.getElementById('searchItemCompany');
            while (select.options.length > 1) {
              select.remove(1);
            }
            response.companies.forEach(function(company) {
              const option = document.createElement('option');
              option.value = company;
              option.textContent = company;
              select.appendChild(option);
            });
          }
        })
        .getCompanyList(sessionToken);
    }

    // Item ì¶”ê°€/ìˆ˜ì • ëª¨ë‹¬ìš© ì—…ì²´ëª… ëª©ë¡ ë¡œë“œ (ì¼ë°˜ ê¶Œí•œ ì—…ì²´ë§Œ)
    function loadItemEditCompanyList(callback) {
      google.script.run
        .withSuccessHandler(function(response) {
          if (response.success && response.companies) {
            const select = document.getElementById('itemCompanyName');
            // ì²« ë²ˆì§¸ ì˜µì…˜(placeholder) ì œì™¸í•˜ê³  ëª¨ë‘ ì œê±°
            while (select.options.length > 1) {
              select.remove(1);
            }
            // ì—…ì²´ëª… ëª©ë¡ ì¶”ê°€
            response.companies.forEach(function(company) {
              const option = document.createElement('option');
              option.value = company;
              option.textContent = company;
              select.appendChild(option);
            });
            // ì½œë°± í•¨ìˆ˜ê°€ ìˆìœ¼ë©´ ì‹¤í–‰
            if (callback) callback();
          }
        })
        .getNormalCompanyList(sessionToken);
    }

    // Item ëª©ë¡ ë¡œë“œ
    function loadItems(filters) {
      const options = filters || {};
      google.script.run
        .withSuccessHandler(displayItems)
        .withFailureHandler(function(error) {
          console.error('Item ë¡œë“œ ì‹¤íŒ¨:', error);
        })
        .getItems(sessionToken, options);
    }

    // Item ëª©ë¡ í‘œì‹œ
    function displayItems(response) {
      const container = document.getElementById('itemListContainer');

      if (!response.success || response.data.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 60px 20px; color: #999;">
            <div style="font-size: 64px; margin-bottom: 20px;">ğŸ“­</div>
            <p>ë“±ë¡ëœ Itemì´ ì—†ìŠµë‹ˆë‹¤.</p>
          </div>
        `;
        return;
      }

      let html = '<table style="width: 100%; border-collapse: collapse; margin-top: 20px;"><thead style="background-color: #f8f9fa;"><tr><th style="padding: 12px; text-align: left; font-weight: 600; color: #555; border-bottom: 2px solid #e0e0e0; font-size: 14px; width: 20%;">ì—…ì²´ëª…</th><th style="padding: 12px; text-align: left; font-weight: 600; color: #555; border-bottom: 2px solid #e0e0e0; font-size: 14px; width: 13%;">TM-NO</th><th style="padding: 12px; text-align: left; font-weight: 600; color: #555; border-bottom: 2px solid #e0e0e0; font-size: 14px; width: 20%;">ì œí’ˆëª…</th><th style="padding: 12px; text-align: left; font-weight: 600; color: #555; border-bottom: 2px solid #e0e0e0; font-size: 14px; width: 10%;">ê²€ì‚¬í˜•íƒœ</th><th style="padding: 12px; text-align: center; font-weight: 600; color: #555; border-bottom: 2px solid #e0e0e0; font-size: 14px; width: 15%;">ê·œê²©</th><th style="padding: 12px; text-align: center; font-weight: 600; color: #555; border-bottom: 2px solid #e0e0e0; font-size: 14px; width: 22%;">ì‘ì—…</th></tr></thead><tbody>';

      response.data.forEach(function(item) {
        // ê·œê²©ë“±ë¡ ë²„íŠ¼ ê²°ì •
        let specButton;
        const specKey = item.tmNo + '|' + item.companyName;
        const specCount = specItemMap[specKey] || 0;

        if (item.inspectionType === 'ë¬´ê²€ì‚¬') {
          // ë¬´ê²€ì‚¬ì¸ ê²½ìš°
          specButton = '<span style="padding: 5px 10px; background: #9e9e9e; color: white; border-radius: 4px; font-size: 12px;">ë¬´ê²€ì‚¬</span>';
        } else if (specCount > 0) {
          // ê·œê²© ë“±ë¡ë¨
          specButton = `<button onclick='showSpecModal("${item.tmNo}", "${item.productName}", "${item.companyName}", true)' style="padding: 6px 12px; font-size: 12px; border-radius: 6px; border: none; cursor: pointer; background: #4caf50; color: white;">âœ… ê·œê²© (${specCount}ê°œ)</button>`;
        } else {
          // ê·œê²© ë¯¸ë“±ë¡
          specButton = `<button onclick='showSpecModal("${item.tmNo}", "${item.productName}", "${item.companyName}", false)' style="padding: 6px 12px; font-size: 12px; border-radius: 6px; border: none; cursor: pointer; background: #ff9800; color: white;">ğŸ“‹ ê·œê²©</button>`;
        }

        html += `
          <tr style="transition: background 0.2s;" onmouseover="this.style.backgroundColor='#f9f9f9'" onmouseout="this.style.backgroundColor=''">
            <td style="padding: 12px; border-bottom: 1px solid #f0f0f0; font-size: 14px;">${item.companyName}</td>
            <td style="padding: 12px; border-bottom: 1px solid #f0f0f0; font-size: 14px;">${item.tmNo}</td>
            <td style="padding: 12px; border-bottom: 1px solid #f0f0f0; font-size: 14px;">${item.productName}</td>
            <td style="padding: 12px; border-bottom: 1px solid #f0f0f0; font-size: 14px;">${item.inspectionType}</td>
            <td style="padding: 12px; border-bottom: 1px solid #f0f0f0; font-size: 14px; text-align: center;">${specButton}</td>
            <td style="padding: 12px; border-bottom: 1px solid #f0f0f0; font-size: 14px; text-align: center;">
              <button onclick='editItem(${item.rowIndex}, "${item.tmNo}", "${item.productName}", "${item.companyName}", "${item.inspectionType}")' style="padding: 6px 12px; font-size: 12px; border-radius: 6px; border: none; cursor: pointer; margin-right: 5px; background: #ffc107; color: white;">âœï¸ ìˆ˜ì •</button>
              <button onclick='deleteItemConfirm(${item.rowIndex})' style="padding: 6px 12px; font-size: 12px; border-radius: 6px; border: none; cursor: pointer; background: #f44336; color: white;">ğŸ—‘ï¸ ì‚­ì œ</button>
            </td>
          </tr>
        `;
      });

      html += '</tbody></table>';
      container.innerHTML = html;
    }

    // Item ê²€ìƒ‰
    function searchItems() {
      const companyName = document.getElementById('searchItemCompany').value.trim();
      const tmNo = document.getElementById('searchItemTmNo').value.trim();

      const filters = {};
      if (companyName) filters.companyName = companyName;
      if (tmNo) filters.tmNo = tmNo;

      loadItems(filters);
    }

    // Item ê²€ìƒ‰ ì´ˆê¸°í™”
    function clearItemSearch() {
      document.getElementById('searchItemCompany').value = '';
      document.getElementById('searchItemTmNo').value = '';
      loadItems();
    }

    // Item ì¶”ê°€ ëª¨ë‹¬ ì—´ê¸°
    function showItemAddModal() {
      document.getElementById('itemModalTitle').textContent = 'Item ì¶”ê°€';
      document.getElementById('itemRowIndex').value = '';
      document.getElementById('itemTmNo').value = '';
      document.getElementById('itemProductName').value = '';
      document.getElementById('itemCompanyName').value = '';
      document.getElementById('itemInspectionType').value = '';

      const select = document.getElementById('itemCompanyName');

      // ì¼ë°˜ ê¶Œí•œìì¸ ê²½ìš° ì—…ì²´ëª… ìë™ ì…ë ¥ ë° ì½ê¸° ì „ìš©
      if (currentUser && currentUser.role !== 'ê´€ë¦¬ì') {
        // ì¼ë°˜ ì‚¬ìš©ìì˜ ê²½ìš° ìì‹ ì˜ ì—…ì²´ëª…ë§Œ ì˜µì…˜ìœ¼ë¡œ ì¶”ê°€
        select.innerHTML = '<option value="">ì—…ì²´ëª… ì„ íƒ</option>';
        const option = document.createElement('option');
        option.value = currentUser.companyName;
        option.textContent = currentUser.companyName;
        select.appendChild(option);
        select.value = currentUser.companyName;
        select.disabled = true;
      } else {
        // ê´€ë¦¬ìëŠ” ì„ íƒ ê°€ëŠ¥
        select.disabled = false;
        loadItemEditCompanyList();
      }

      document.getElementById('itemEditModal').style.display = 'block';
    }

    // Item ìˆ˜ì • ëª¨ë‹¬ ì—´ê¸°
    function editItem(rowIndex, tmNo, productName, companyName, inspectionType) {
      document.getElementById('itemModalTitle').textContent = 'Item ìˆ˜ì •';
      document.getElementById('itemRowIndex').value = rowIndex;
      document.getElementById('itemTmNo').value = tmNo;
      document.getElementById('itemProductName').value = productName;
      document.getElementById('itemInspectionType').value = inspectionType;

      const select = document.getElementById('itemCompanyName');

      // ì¼ë°˜ ê¶Œí•œìëŠ” ì—…ì²´ëª… ë³€ê²½ ë¶ˆê°€
      if (currentUser && currentUser.role !== 'ê´€ë¦¬ì') {
        // ì¼ë°˜ ì‚¬ìš©ìì˜ ê²½ìš° í•´ë‹¹ ì—…ì²´ëª…ë§Œ í‘œì‹œ
        select.innerHTML = '<option value="">ì—…ì²´ëª… ì„ íƒ</option>';
        const option = document.createElement('option');
        option.value = companyName;
        option.textContent = companyName;
        select.appendChild(option);
        select.value = companyName;
        select.disabled = true;
      } else {
        // ê´€ë¦¬ìëŠ” ì„ íƒ ê°€ëŠ¥
        select.disabled = false;
        loadItemEditCompanyList(function() {
          document.getElementById('itemCompanyName').value = companyName;
        });
      }

      document.getElementById('itemEditModal').style.display = 'block';
    }

    // Item ì¶”ê°€/ìˆ˜ì • ëª¨ë‹¬ ë‹«ê¸°
    function closeItemEditModal() {
      document.getElementById('itemEditModal').style.display = 'none';
    }

    // Item ì €ì¥
    function saveItem() {
      const rowIndex = document.getElementById('itemRowIndex').value;
      const itemData = {
        tmNo: document.getElementById('itemTmNo').value.trim(),
        productName: document.getElementById('itemProductName').value.trim(),
        companyName: document.getElementById('itemCompanyName').value.trim(),
        inspectionType: document.getElementById('itemInspectionType').value.trim()
      };

      if (!itemData.tmNo || !itemData.productName || !itemData.companyName) {
        alert('TM-NO, ì œí’ˆëª…, ì—…ì²´ëª…ì€ í•„ìˆ˜ ì…ë ¥ í•­ëª©ì…ë‹ˆë‹¤.');
        return;
      }

      if (rowIndex) {
        // ìˆ˜ì •
        google.script.run
          .withSuccessHandler(function(response) {
            if (response.success) {
              alert('Itemì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
              closeItemEditModal();
              loadItems();
            } else {
              alert(response.message);
            }
          })
          .updateItem(sessionToken, parseInt(rowIndex), itemData);
      } else {
        // ì¶”ê°€
        google.script.run
          .withSuccessHandler(function(response) {
            if (response.success) {
              alert('Itemì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
              closeItemEditModal();
              loadItems();
            } else {
              alert(response.message);
            }
          })
          .addItem(sessionToken, itemData);
      }
    }

    // Item ì‚­ì œ í™•ì¸
    function deleteItemConfirm(rowIndex) {
      if (confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        google.script.run
          .withSuccessHandler(function(response) {
            if (response.success) {
              alert('Itemì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
              loadItems();
            } else {
              alert(response.message);
            }
          })
          .deleteItem(sessionToken, rowIndex);
      }
    }

    // ========== ê²€ì‚¬ê·œê²© ê´€ë¦¬ í•¨ìˆ˜ë“¤ ==========
    let editingSpecTmNo = null;
    let specItemMap = {}; // TM-NO|ì—…ì²´ëª… â†’ ê·œê²© ê°œìˆ˜

    // ê²€ì‚¬ê·œê²© ë“±ë¡ ìƒíƒœ ë¡œë“œ
    function loadItemSpecCounts() {
      google.script.run
        .withSuccessHandler(function(response) {
          if (response.success && response.data) {
            // TM-NO + ì—…ì²´ëª…ë³„ë¡œ ê·¸ë£¹í™”
            const grouped = {};
            response.data.forEach(function(spec) {
              const key = spec.tmNo + '|' + spec.companyName;
              if (!grouped[key]) {
                grouped[key] = [];
              }
              grouped[key].push(spec);
            });

            // ê°œìˆ˜ë¥¼ specItemMapì— ì €ì¥
            specItemMap = {};
            Object.keys(grouped).forEach(function(key) {
              specItemMap[key] = grouped[key].length;
            });
          }
        })
        .getInspectionSpecs(sessionToken, {});
    }

    // ê²€ì‚¬ê·œê²© ëª¨ë‹¬ ì—´ê¸°
    function showSpecModal(tmNo, productName, companyName, isEdit) {
      // ìˆ˜ì • ëª¨ë“œ ëª…í™•íˆ ì„¤ì •
      if (isEdit === true || isEdit === 'true') {
        editingSpecTmNo = tmNo;
      } else {
        editingSpecTmNo = null;
      }

      document.getElementById('specModalTitle').textContent = editingSpecTmNo ? 'ê²€ì‚¬ ê·œê²© ìˆ˜ì •' : 'ê²€ì‚¬ ê·œê²© ì¶”ê°€';
      document.getElementById('specTmNo').value = tmNo;
      document.getElementById('specProductName').value = productName;
      document.getElementById('specCompanyName').value = companyName;

      const tbody = document.getElementById('specItemsBody');
      tbody.innerHTML = '';

      if (editingSpecTmNo) {
        // ê¸°ì¡´ ê·œê²© ë¡œë“œ - TM-NOì™€ ì—…ì²´ëª…ìœ¼ë¡œ í•„í„°ë§
        google.script.run
          .withSuccessHandler(function(response) {
            if (response.success && response.data) {
              response.data.forEach(function(spec) {
                addSpecRow(spec);
              });
            }
          })
          .getInspectionSpecs(sessionToken, {tmNo: tmNo, companyName: companyName});
      } else {
        // ë¹ˆ í–‰ í•˜ë‚˜ ì¶”ê°€
        addSpecRow();
      }

      document.getElementById('specModal').style.display = 'block';
    }

    // ê²€ì‚¬ê·œê²© ëª¨ë‹¬ ë‹«ê¸°
    function closeSpecModal() {
      document.getElementById('specModal').style.display = 'none';
      editingSpecTmNo = null;
    }

    // ê²€ì‚¬í•­ëª© í–‰ ì¶”ê°€
    function addSpecRow(spec) {
      const tbody = document.getElementById('specItemsBody');
      const row = document.createElement('tr');

      row.innerHTML = `
        <td style="padding: 8px; border: 1px solid #ddd;">
          <input type="text" value="${spec ? spec.inspectionItem : ''}" placeholder="ê²€ì‚¬í•­ëª©" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
        </td>
        <td style="padding: 8px; border: 1px solid #ddd;">
          <input type="text" value="${spec ? spec.measurementMethod : ''}" placeholder="ì¸¡ì •ë°©ë²•" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
        </td>
        <td style="padding: 8px; border: 1px solid #ddd;">
          <input type="text" value="${spec ? spec.lowerLimit : ''}" placeholder="ê·œê²©í•˜í•œ" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
        </td>
        <td style="padding: 8px; border: 1px solid #ddd;">
          <input type="text" value="${spec ? spec.upperLimit : ''}" placeholder="ê·œê²©ìƒí•œ" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
        </td>
        <td style="padding: 8px; border: 1px solid #ddd;">
          <input type="number" value="${spec ? spec.sampleSize : ''}" placeholder="ì‹œë£Œìˆ˜" min="1" max="10" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
        </td>
        <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">
          <button onclick="removeSpecRow(this)" style="padding: 4px 8px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">âŒ</button>
        </td>
      `;

      tbody.appendChild(row);
    }

    // ê²€ì‚¬í•­ëª© í–‰ ì‚­ì œ
    function removeSpecRow(button) {
      const row = button.closest('tr');
      row.remove();
    }

    // ê²€ì‚¬ê·œê²© ì €ì¥
    function saveItemSpecs() {
      const tmNo = document.getElementById('specTmNo').value.trim();
      const productName = document.getElementById('specProductName').value.trim();
      const companyName = document.getElementById('specCompanyName').value.trim();

      if (!tmNo || !productName || !companyName) {
        alert('TM-NO, ì œí’ˆëª…, ì—…ì²´ëª…ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      const rows = document.querySelectorAll('#specItemsBody tr');
      const specs = [];

      rows.forEach(function(row) {
        const inputs = row.querySelectorAll('input');
        const inspectionItem = inputs[0].value.trim();
        const measurementMethod = inputs[1].value.trim();
        const lowerLimit = inputs[2].value.trim();
        const upperLimit = inputs[3].value.trim();
        const sampleSize = inputs[4].value.trim();

        if (inspectionItem) {
          specs.push({
            tmNo: tmNo,
            productName: productName,
            companyName: companyName,
            inspectionItem: inspectionItem,
            measurementMethod: measurementMethod,
            lowerLimit: lowerLimit,
            upperLimit: upperLimit,
            sampleSize: sampleSize
          });
        }
      });

      if (specs.length === 0) {
        alert('ìµœì†Œ 1ê°œì˜ ê²€ì‚¬í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      // ìˆ˜ì • ëª¨ë“œì¸ ê²½ìš° ê¸°ì¡´ ë°ì´í„° ë¨¼ì € ì‚­ì œ í›„ ì¶”ê°€ (ì¤‘ë³µ ë°©ì§€)
      if (editingSpecTmNo !== null && editingSpecTmNo !== undefined) {
        console.log('ìˆ˜ì • ëª¨ë“œ: ê¸°ì¡´ ë°ì´í„° ì‚­ì œ í›„ ì¶”ê°€', editingSpecTmNo, companyName);
        google.script.run
          .withSuccessHandler(function(deleteResponse) {
            if (deleteResponse.success) {
              console.log('ê¸°ì¡´ ë°ì´í„° ì‚­ì œ ì™„ë£Œ, ìƒˆ ë°ì´í„° ì¶”ê°€ ì‹œì‘');
              // ì‚­ì œ ì„±ê³µ í›„ ìƒˆ ë°ì´í„° ì¶”ê°€
              google.script.run
                .withSuccessHandler(function(response) {
                  if (response.success) {
                    alert('ê²€ì‚¬ ê·œê²©ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    closeSpecModal();
                    loadItemSpecCounts();
                    loadItems();
                  } else {
                    alert(response.message || 'ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                  }
                })
                .withFailureHandler(function(error) {
                  console.error('ì €ì¥ ì‹¤íŒ¨:', error);
                  alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                })
                .addInspectionSpecsBatch(sessionToken, specs);
            } else {
              alert(deleteResponse.message || 'ê¸°ì¡´ ë°ì´í„° ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
          })
          .withFailureHandler(function(error) {
            console.error('ì‚­ì œ ì‹¤íŒ¨:', error);
            alert('ê¸°ì¡´ ë°ì´í„° ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
          })
          .deleteInspectionSpecsByTmNoAndCompany(sessionToken, tmNo, companyName);
      } else {
        // ì¶”ê°€ ëª¨ë“œì¸ ê²½ìš° ë°”ë¡œ ì¶”ê°€
        console.log('ì¶”ê°€ ëª¨ë“œ: ìƒˆ ë°ì´í„° ì¶”ê°€', tmNo, companyName);
        google.script.run
          .withSuccessHandler(function(response) {
            if (response.success) {
              alert('ê²€ì‚¬ ê·œê²©ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
              closeSpecModal();
              loadItemSpecCounts();
              loadItems();
            } else {
              alert(response.message || 'ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
          })
          .withFailureHandler(function(error) {
            console.error('ì €ì¥ ì‹¤íŒ¨:', error);
            alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
          })
          .addInspectionSpecsBatch(sessionToken, specs);
      }
    }
  </script>
</body>
</html>
