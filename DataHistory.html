<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì´ë ¥ ê´€ë¦¬ - ê²€ì‚¬ì„±ì ì„œ ê´€ë¦¬</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f5f7fa;
      color: #333;
    }
    
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
    }
    
    .header-title h1 {
      font-size: 24px;
      margin-bottom: 5px;
    }
    
    .header-title p {
      font-size: 14px;
      opacity: 0.9;
    }
    
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .btn-outline {
      background: transparent;
      color: white;
      border: 2px solid white;
    }
    
    .btn-outline:hover {
      background: white;
      color: #667eea;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 30px 20px;
    }
    
    .nav-menu {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 30px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }
    
    .nav-btn {
      padding: 12px 24px;
      background: #f0f4ff;
      color: #667eea;
      border: 2px solid transparent;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .nav-btn:hover {
      background: #667eea;
      color: white;
      transform: translateY(-2px);
    }
    
    .nav-btn.active {
      background: #667eea;
      color: white;
    }
    
    .section {
      background: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      margin-bottom: 30px;
    }
    
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #f0f0f0;
      flex-wrap: wrap;
      gap: 15px;
    }
    
    .section-title {
      font-size: 20px;
      font-weight: bold;
      color: #333;
    }
    
    .search-bar {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      flex: 1;
      justify-content: flex-end;
    }
    
    .search-input {
      padding: 10px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      min-width: 200px;
    }
    
    .search-input:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .btn-search {
      padding: 10px 20px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
    }
    
    .btn-search:hover {
      background: #5568d3;
    }
    
    .table-responsive {
      overflow-x: auto;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 800px;
    }
    
    thead {
      background-color: #f8f9fa;
    }
    
    th {
      padding: 12px;
      text-align: left;
      font-weight: 600;
      color: #555;
      border-bottom: 2px solid #e0e0e0;
      font-size: 14px;
      white-space: nowrap;
    }
    
    td {
      padding: 12px;
      border-bottom: 1px solid #f0f0f0;
      font-size: 14px;
    }
    
    tbody tr:hover {
      background-color: #f8f9fa;
    }
    
    .action-buttons {
      display: flex;
      gap: 5px;
      flex-wrap: wrap;
    }
    
    .btn-sm {
      padding: 6px 12px;
      border: none;
      border-radius: 5px;
      font-size: 12px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
    }
    
    .btn-edit {
      background: #4caf50;
      color: white;
    }
    
    .btn-edit:hover {
      background: #45a049;
    }
    
    .btn-delete {
      background: #f44336;
      color: white;
    }
    
    .btn-delete:hover {
      background: #da190b;
    }
    
    .btn-view {
      background: #2196f3;
      color: white;
    }
    
    .btn-view:hover {
      background: #0b7dda;
    }
    
    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      margin-top: 20px;
    }
    
    .page-btn {
      padding: 8px 12px;
      border: 1px solid #ddd;
      background: white;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
    }
    
    .page-btn:hover {
      background: #f0f0f0;
    }
    
    .page-btn.active {
      background: #667eea;
      color: white;
      border-color: #667eea;
    }
    
    .page-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }
    
    .empty-icon {
      font-size: 64px;
      margin-bottom: 20px;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
    }
    
    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* ëª¨ë‹¬ */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      overflow-y: auto;
    }
    
    .modal-content {
      background-color: white;
      margin: 50px auto;
      padding: 30px;
      border-radius: 12px;
      width: 90%;
      max-width: 600px;
      box-shadow: 0 5px 30px rgba(0,0,0,0.3);
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #f0f0f0;
    }
    
    .modal-title {
      font-size: 20px;
      font-weight: bold;
    }
    
    .close {
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      color: #999;
    }
    
    .close:hover {
      color: #333;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-label {
      display: block;
      font-weight: 600;
      margin-bottom: 5px;
      font-size: 14px;
    }
    
    .form-control {
      width: 100%;
      padding: 10px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
    }
    
    .form-control:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 20px;
    }
    
    .btn-cancel {
      padding: 10px 20px;
      background: #f0f0f0;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
    }
    
    .btn-save {
      padding: 10px 20px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
    }
    
    @media (max-width: 768px) {
      .search-bar {
        width: 100%;
      }
      
      .search-input {
        flex: 1;
        min-width: auto;
      }
      
      .nav-menu {
        flex-direction: column;
      }
      
      .nav-btn {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-content">
      <div class="header-title">
        <h1>í˜‘ë ¥ì‚¬ ìˆ˜ì…ê²€ì‚¬ ê´€ë¦¬</h1>
        <p id="userInfo">ë¡œë”© ì¤‘...</p>
      </div>
      <div class="header-actions">
        <button class="btn btn-outline" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
      </div>
    </div>
  </div>
  
  <div class="container">
    <?!= include('Navigation') ?>
    
    <div class="section">
      <div class="section-header">
        <h2 class="section-title">ì„±ì ì„œ ì´ë ¥</h2>
        <div class="search-bar">
          <select class="search-input" id="searchCompany">
            <option value="">ì—…ì²´ëª… (ì „ì²´)</option>
          </select>
          <input type="date" class="search-input" id="searchDate" placeholder="ì…ê³ ë‚ ì§œ">
          <input type="text" class="search-input" id="searchTmNo" placeholder="TM-NO">
          <button class="btn-search" onclick="searchData()">ğŸ” ê²€ìƒ‰</button>
          <button class="btn-search" onclick="clearSearch()" style="background: #6c757d;">ì´ˆê¸°í™”</button>
        </div>
      </div>
      
      <div id="tableContainer">
        <div class="loading">
          <div class="spinner"></div>
          <p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
        </div>
      </div>
      
      <div id="paginationContainer"></div>
    </div>
  </div>
  
  <!-- ìˆ˜ì • ëª¨ë‹¬ -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">ì„±ì ì„œ ìˆ˜ì •</h3>
        <span class="close" onclick="closeEditModal()">&times;</span>
      </div>
      
      <form id="editForm" onsubmit="handleUpdate(event)">
        <input type="hidden" id="editId">
        
        <div class="form-group">
          <label class="form-label">ì…ê³ ë‚ ì§œ</label>
          <input type="date" class="form-control" id="editDate" required>
        </div>
        
        <div class="form-group">
          <label class="form-label">ì…ê³ ì‹œê°„</label>
          <select class="form-control" id="editTime" required></select>
        </div>
        
        <div class="form-group">
          <label class="form-label">TM-NO</label>
          <input type="text" class="form-control" id="editTmNo" required>
        </div>
        
        <div class="form-group">
          <label class="form-label">ì œí’ˆëª…</label>
          <input type="text" class="form-control" id="editProductName" required>
        </div>
        
        <div class="form-group">
          <label class="form-label">ìˆ˜ëŸ‰</label>
          <input type="number" class="form-control" id="editQuantity" min="0" required>
        </div>
        
        <div class="modal-footer">
          <button type="button" class="btn-cancel" onclick="closeEditModal()">ì·¨ì†Œ</button>
          <button type="submit" class="btn-save">ì €ì¥</button>
        </div>
      </form>
    </div>
  </div>
  
  <script>
    // ===== í† í° ê´€ë¦¬ =====
    let sessionToken = null;

    // í† í° ì´ˆê¸°í™” (ì„œë²„ì—ì„œ ì „ë‹¬ë°›ì€ í† í° ë˜ëŠ” sessionStorageì—ì„œ)
    function initToken() {
      // ì„œë²„ì—ì„œ ì „ë‹¬ë°›ì€ í† í° (í…œí”Œë¦¿ ë³€ìˆ˜)
      const serverToken = '<?!= token ?>';

      if (serverToken && serverToken !== 'undefined' && serverToken.length > 10) {
        sessionToken = serverToken;
        sessionStorage.setItem('sessionToken', serverToken);
        console.log('í† í° ì´ˆê¸°í™” ì™„ë£Œ (ì„œë²„ì—ì„œ ì „ë‹¬)');
      } else {
        // sessionStorageì—ì„œ í† í° ê°€ì ¸ì˜¤ê¸°
        sessionToken = sessionStorage.getItem('sessionToken');
        console.log('í† í° ì´ˆê¸°í™” ì™„ë£Œ (sessionStorage)');
      }

      if (!sessionToken) {
        console.error('í† í° ì—†ìŒ - ë¡œê·¸ì¸ í•„ìš”');
        redirectToLogin();
      }

      return sessionToken;
    }

    // ì•ˆì „í•œ í˜ì´ì§€ ì´ë™ (iframe ìƒŒë“œë°•ìŠ¤ í˜¸í™˜)
    function safeNavigate(url, params) {
      // Query string ìƒì„±
      let fullUrl = url;
      if (params) {
        const queryString = Object.keys(params)
          .map(key => encodeURIComponent(key) + '=' + encodeURIComponent(params[key]))
          .join('&');
        fullUrl = url + '?' + queryString;
      }

      // window.top.location.hrefë¡œ ì§ì ‘ ë„¤ë¹„ê²Œì´ì…˜
      // form.submit()ì€ ì‚¬ìš©ì ì œìŠ¤ì²˜ë¡œ ê°„ì£¼ë˜ì§€ ì•Šì•„ sandbox ì—ëŸ¬ ë°œìƒ
      window.top.location.href = fullUrl;
    }

    // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
    function redirectToLogin() {
      sessionStorage.removeItem('sessionToken');
      safeNavigate('https://script.google.com/macros/s/AKfycbxQB4616RO3VVmBmKV4oiuyL0TM5FXmXRG6qWSxqBMfKg8MzfoTt9p0AWPbZbUdUtvs9g/exec', null);
    }

    let currentPage = 1;
    let totalPages = 1;
    let searchFilters = {
      company: '',
      date: '',
      tmNo: ''
    };
    let inspectionResultKeys = new Set(); // ê²€ì‚¬ì™„ë£Œëœ ë°ì´í„° í‚¤ ì €ì¥
    let currentUser = null; // í˜„ì¬ ë¡œê·¸ì¸ ì‚¬ìš©ì ì •ë³´ ì €ì¥

    window.onload = function() {
      initToken();
      loadUserInfo();
      loadCompanyList();
      initializeTimeOptions();
      loadInspectionResultKeys(); // ê²€ì‚¬ê²°ê³¼ í‚¤ ë¡œë“œ í›„ ë°ì´í„° ë¡œë“œ
    };

    // ê²€ì‚¬ê²°ê³¼ í‚¤ ë¡œë“œ
    function loadInspectionResultKeys(callback) {
      google.script.run
        .withSuccessHandler(function(response) {
          if (response.success && response.keys) {
            inspectionResultKeys = new Set(response.keys);
          }
          // ì½œë°±ì´ ìˆìœ¼ë©´ ì‹¤í–‰, ì—†ìœ¼ë©´ loadData() ì‹¤í–‰
          if (callback && typeof callback === 'function') {
            callback();
          } else {
            loadData();
          }
        })
        .withFailureHandler(function(error) {
          console.error('ê²€ì‚¬ê²°ê³¼ í‚¤ ë¡œë“œ ì‹¤íŒ¨:', error);
          // ì‹¤íŒ¨í•´ë„ ë°ì´í„°ëŠ” ë¡œë“œ
          if (callback && typeof callback === 'function') {
            callback();
          } else {
            loadData();
          }
        })
        .getAllInspectionResultKeys(sessionToken);
    }

    // ë„¤ë¹„ê²Œì´ì…˜ ì´ˆê¸°í™” í•¨ìˆ˜
    function initNavigation(currentPage, userRole) {
      const navButtons = {
        'dashboard': 'navDashboard',
        'entry': 'navEntry',
        'history': 'navHistory',
        'certificate': 'navCertificate'
      };

      if (navButtons[currentPage]) {
        const btn = document.getElementById(navButtons[currentPage]);
        if (btn) {
          btn.classList.add('active');
        }
      }

      // Item ë“±ë¡ ë²„íŠ¼ì€ ëŒ€ì‹œë³´ë“œì—ì„œë§Œ í‘œì‹œ
      const itemBtn = document.getElementById('navItem');
      if (itemBtn) {
        itemBtn.style.display = (currentPage === 'dashboard') ? 'inline-block' : 'none';
      }

      // ì‚¬ìš©ì ê´€ë¦¬ ë²„íŠ¼ì€ ê´€ë¦¬ìë§Œ í‘œì‹œ
      const usersBtn = document.getElementById('navUsers');
      if (usersBtn) {
        usersBtn.style.display = (userRole === 'ê´€ë¦¬ì') ? 'inline-block' : 'none';
      }

      // ë„¤ë¹„ê²Œì´ì…˜ ë©”ë‰´ í‘œì‹œ (ë¶€ë“œëŸ¬ìš´ fade-in íš¨ê³¼)
      const navMenu = document.getElementById('navMenu');
      if (navMenu) {
        navMenu.style.opacity = '1';
      }
    }

    // Item í´ë¦­ í•¸ë“¤ëŸ¬
    function handleItemClick() {
      goToPage('dashboard');
    }

    function loadUserInfo() {
      google.script.run
        .withSuccessHandler(function(response) {
          if (response.success) {
            const user = response.user;
            currentUser = user; // ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
            document.getElementById('userInfo').textContent =
              `${user.companyName} | ${user.name} (${user.role})`;

            // ë„¤ë¹„ê²Œì´ì…˜ ì´ˆê¸°í™”
            initNavigation('history', user.role);
          } else {
            redirectToLogin();
          }
        })
        .getCurrentUserByToken(sessionToken);
    }

    function loadCompanyList() {
      google.script.run
        .withSuccessHandler(function(response) {
          if (response.success && response.companies) {
            const select = document.getElementById('searchCompany');

            // ê¸°ì¡´ ì˜µì…˜ë“¤ ì œê±° (ì²« ë²ˆì§¸ "ì „ì²´" ì˜µì…˜ ì œì™¸)
            while (select.options.length > 1) {
              select.remove(1);
            }

            // ì—…ì²´ëª… ì˜µì…˜ ì¶”ê°€
            response.companies.forEach(function(company) {
              const option = document.createElement('option');
              option.value = company;
              option.textContent = company;
              select.appendChild(option);
            });
          }
        })
        .withFailureHandler(function(error) {
          console.error('ì—…ì²´ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
        })
        .getCompanyList(sessionToken);
    }

    function initializeTimeOptions() {
      const timeSelect = document.getElementById('editTime');
      
      const option1 = document.createElement('option');
      option1.value = 'ì˜¤ì „';
      option1.textContent = 'ì˜¤ì „';
      timeSelect.appendChild(option1);
      
      const option2 = document.createElement('option');
      option2.value = 'ì˜¤í›„';
      option2.textContent = 'ì˜¤í›„';
      timeSelect.appendChild(option2);
    }
    
    function loadData(page = 1) {
      currentPage = page;

      const options = {
        page: page,
        pageSize: 20,
        searchCompany: searchFilters.company,
        searchDate: searchFilters.date,
        searchTmNo: searchFilters.tmNo
      };
      
      google.script.run
        .withSuccessHandler(displayData)
        .withFailureHandler(function(error) {
          console.error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
          showError('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        })
        .getData(sessionToken, options);
    }
    
    function displayData(response) {
      const container = document.getElementById('tableContainer');
      
      // null ì²´í¬ ì¶”ê°€
      if (!response) {
        showError('ì„œë²„ ì‘ë‹µì´ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      if (!response.success) {
        showError(response.message || 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      
      const data = response.data || [];
      totalPages = response.totalPages || 0;
      
      if (data.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">ğŸ“­</div>
            <p>ë“±ë¡ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
          </div>
        `;
        document.getElementById('paginationContainer').innerHTML = '';
        return;
      }
      
      // ê´€ë¦¬ì ì—¬ë¶€ í™•ì¸
      const isAdmin = currentUser && currentUser.role === 'ê´€ë¦¬ì';

      let html = `
        <div class="table-responsive">
          <table>
            <thead>
              <tr>
                <th>ì—…ì²´ëª…</th>
                <th>ì…ê³ ë‚ ì§œ</th>
                <th>ì…ê³ ì‹œê°„</th>
                <th>TM-NO</th>
                <th>ì œí’ˆëª…</th>
                <th>ìˆ˜ëŸ‰</th>
                <th>ë“±ë¡ì¼ì‹œ</th>
                ${isAdmin ? '<th>ìˆ˜ì…ê²€ì‚¬</th>' : ''}
                <th>ì‘ì—…</th>
              </tr>
            </thead>
            <tbody>
      `;

      data.forEach(function(item) {
        const createdAt = item.createdAt || '-';
        const pdfButton = item.pdfUrl ?
          `<button class="btn-sm btn-view" onclick="viewPdf('${item.pdfUrl}')">ğŸ“„ ë³´ê¸°</button>` : '';

        // ê²€ì‚¬í˜•íƒœ í™•ì¸
        let inspectionButton;
        if (item.inspectionType === 'ë¬´ê²€ì‚¬') {
          // ë¬´ê²€ì‚¬ì¸ ê²½ìš°
          inspectionButton = `<span style="padding: 5px 10px; background: #9e9e9e; color: white; border-radius: 3px; font-size: 12px;">ë¬´ê²€ì‚¬</span>`;
        } else {
          // ê²€ì‚¬ê°€ í•„ìš”í•œ ê²½ìš°
          const inspectionKey = item.date + '|' + item.companyName + '|' + item.tmNo;
          const hasInspectionResult = inspectionResultKeys.has(inspectionKey);

          inspectionButton = hasInspectionResult ?
            `<button class="btn-sm" style="background: #4caf50; color: white;" onclick="viewInspectionResults('${item.id}', '${item.companyName}', '${item.tmNo}', '${item.productName}', '${item.date}')">âœ… ê²€ì‚¬ì™„ë£Œ</button>` :
            `<button class="btn-sm" style="background: #ff9800; color: white;" onclick="openInspectionModal('${item.id}', '${item.companyName}', '${item.tmNo}', '${item.productName}', '${item.date}')">ğŸ” ê²€ì‚¬ëŒ€ê¸°</button>`;
        }

        html += `
          <tr>
            <td>${item.companyName}</td>
            <td>${item.date}</td>
            <td>${item.time}</td>
            <td>${item.tmNo}</td>
            <td>${item.productName}</td>
            <td>${item.quantity}</td>
            <td>${createdAt}</td>
            ${isAdmin ? `<td>${inspectionButton}</td>` : ''}
            <td>
              <div class="action-buttons">
                ${pdfButton}
                <button class="btn-sm btn-edit" onclick="editData('${item.id}')">âœï¸ ìˆ˜ì •</button>
                <button class="btn-sm btn-delete" onclick="deleteData('${item.id}')">ğŸ—‘ï¸ ì‚­ì œ</button>
              </div>
            </td>
          </tr>
        `;
      });
      
      html += `
            </tbody>
          </table>
        </div>
      `;
      
      container.innerHTML = html;
      
      // í˜ì´ì§€ë„¤ì´ì…˜ í‘œì‹œ
      displayPagination();
    }
    
    function displayPagination() {
      const container = document.getElementById('paginationContainer');
      
      if (totalPages <= 1) {
        container.innerHTML = '';
        return;
      }
      
      let html = '<div class="pagination">';
      
      // ì´ì „ ë²„íŠ¼
      html += `<button class="page-btn" onclick="loadData(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>â—€ ì´ì „</button>`;
      
      // í˜ì´ì§€ ë²ˆí˜¸
      for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
          html += `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="loadData(${i})">${i}</button>`;
        } else if (i === currentPage - 3 || i === currentPage + 3) {
          html += '<span>...</span>';
        }
      }
      
      // ë‹¤ìŒ ë²„íŠ¼
      html += `<button class="page-btn" onclick="loadData(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>ë‹¤ìŒ â–¶</button>`;
      
      html += '</div>';
      
      container.innerHTML = html;
    }
    
    function searchData() {
      searchFilters.company = document.getElementById('searchCompany').value.trim();
      searchFilters.date = document.getElementById('searchDate').value.trim();
      searchFilters.tmNo = document.getElementById('searchTmNo').value.trim();
      loadData(1);
    }

    function clearSearch() {
      document.getElementById('searchCompany').value = '';
      document.getElementById('searchDate').value = '';
      document.getElementById('searchTmNo').value = '';
      searchFilters = {
        company: '',
        date: '',
        tmNo: ''
      };
      loadData(1);
    }
    
    function viewPdf(url) {
      window.open(url, '_blank');
    }
    
    function editData(id) {
      google.script.run
        .withSuccessHandler(function(response) {
          if (response.success) {
            const data = response.data;
            
            document.getElementById('editId').value = data.id;
            document.getElementById('editDate').value = data.date;
            document.getElementById('editTime').value = data.time;
            document.getElementById('editTmNo').value = data.tmNo;
            document.getElementById('editProductName').value = data.productName;
            document.getElementById('editQuantity').value = data.quantity;
            
            document.getElementById('editModal').style.display = 'block';
          } else {
            alert(response.message);
          }
        })
        .withFailureHandler(function(error) {
          console.error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
          alert('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        })
        .getDataById(id);
    }
    
    function handleUpdate(e) {
      e.preventDefault();
      
      const id = document.getElementById('editId').value;
      const dataObj = {
        date: document.getElementById('editDate').value,
        time: document.getElementById('editTime').value,
        tmNo: document.getElementById('editTmNo').value,
        productName: document.getElementById('editProductName').value,
        quantity: document.getElementById('editQuantity').value
      };
      
      google.script.run
        .withSuccessHandler(function(response) {
          if (response.success) {
            alert('ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
            closeEditModal();
            loadData(currentPage);
          } else {
            alert(response.message);
          }
        })
        .withFailureHandler(function(error) {
          console.error('ìˆ˜ì • ì‹¤íŒ¨:', error);
          alert('ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        })
        .updateData(sessionToken, id, dataObj);
    }

    function deleteData(id) {
      if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
      }

      google.script.run
        .withSuccessHandler(function(response) {
          if (response.success) {
            alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            loadData(currentPage);
          } else {
            alert(response.message);
          }
        })
        .withFailureHandler(function(error) {
          console.error('ì‚­ì œ ì‹¤íŒ¨:', error);
          alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        })
        .deleteData(sessionToken, id);
    }
    
    function closeEditModal() {
      document.getElementById('editModal').style.display = 'none';
    }
    
    function showError(message) {
      const container = document.getElementById('tableContainer');
      container.innerHTML = `
        <div class="empty-state">
          <div class="empty-icon">âš ï¸</div>
          <p>${message}</p>
        </div>
      `;
    }
    
    // ë¡œê·¸ì•„ì›ƒ
    function logout() {
      if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        const token = sessionStorage.getItem('sessionToken');
        google.script.run
          .withSuccessHandler(function() {
            sessionStorage.removeItem('sessionToken');
            safeNavigate('https://script.google.com/macros/s/AKfycbxQB4616RO3VVmBmKV4oiuyL0TM5FXmXRG6qWSxqBMfKg8MzfoTt9p0AWPbZbUdUtvs9g/exec', null);
          })
          .withFailureHandler(function(error) {
            console.error('ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨:', error);
            sessionStorage.removeItem('sessionToken');
            safeNavigate('https://script.google.com/macros/s/AKfycbxQB4616RO3VVmBmKV4oiuyL0TM5FXmXRG6qWSxqBMfKg8MzfoTt9p0AWPbZbUdUtvs9g/exec', null);
          })
          .logoutWithToken(token);
      }
    }

    function goToPage(page) {
      const token = sessionStorage.getItem('sessionToken');
      const webAppUrl = '<?= getWebAppUrl() ?>';
      safeNavigate(webAppUrl, {
        'page': page,
        'token': token,
        't': Date.now()
      });
    }
    
    // ì—”í„°í‚¤ë¡œ ê²€ìƒ‰
    document.addEventListener('DOMContentLoaded', function() {
      const searchInputs = ['searchCompany', 'searchDate', 'searchTmNo'];
      searchInputs.forEach(function(inputId) {
        document.getElementById(inputId).addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            searchData();
          }
        });
      });
    });
    
    // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ì‹œ ë‹«ê¸°
    window.onclick = function(event) {
      const editModal = document.getElementById('editModal');
      if (event.target === editModal) {
        closeEditModal();
      }
      const inspectionModal = document.getElementById('inspectionModal');
      if (event.target === inspectionModal) {
        closeInspectionModal();
      }
      const viewInspectionModal = document.getElementById('viewInspectionModal');
      if (event.target === viewInspectionModal) {
        closeViewInspectionModal();
      }
    };

    // ===== ê²€ì‚¬ê²°ê³¼ ì…ë ¥ ê¸°ëŠ¥ =====
    let currentInspectionData = null;

    // ê²€ì‚¬ ëª¨ë‹¬ ì—´ê¸°
    function openInspectionModal(dataId, companyName, tmNo, productName, date) {
      currentInspectionData = {
        dataId: dataId,
        companyName: companyName,
        tmNo: tmNo,
        productName: productName,
        date: date
      };

      // ê²€ì‚¬ê·œê²© ì¡°íšŒ (TM-NOì™€ ì—…ì²´ëª…ìœ¼ë¡œ)
      google.script.run
        .withSuccessHandler(function(response) {
          if (response.success && response.data && response.data.length > 0) {
            displayInspectionForm(response.data);
            document.getElementById('inspectionModal').style.display = 'block';
          } else {
            alert('ë“±ë¡ëœ ê²€ì‚¬ê·œê²©ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ê²€ì‚¬ê·œê²©ì„ ë“±ë¡í•´ì£¼ì„¸ìš”.');
          }
        })
        .withFailureHandler(function(error) {
          console.error('ê²€ì‚¬ê·œê²© ì¡°íšŒ ì‹¤íŒ¨:', error);
          alert('ê²€ì‚¬ê·œê²© ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        })
        .getInspectionSpecs(sessionToken, {tmNo: tmNo, companyName: companyName});
    }

    // ê²€ì‚¬ ëª¨ë‹¬ ë‹«ê¸°
    function closeInspectionModal() {
      document.getElementById('inspectionModal').style.display = 'none';
      currentInspectionData = null;
    }

    // ê²€ì‚¬ ì…ë ¥ í¼ í‘œì‹œ
    function displayInspectionForm(specs) {
      const tbody = document.getElementById('inspectionItemsBody');
      tbody.innerHTML = '';

      document.getElementById('inspectionInfo').textContent =
        `${currentInspectionData.date} | ${currentInspectionData.companyName} | ${currentInspectionData.tmNo} | ${currentInspectionData.productName}`;

      specs.forEach(function(spec, index) {
        const row = document.createElement('tr');
        row.setAttribute('data-spec-index', index);

        // ì‹œë£Œ ì…ë ¥ì¹¸ ìƒì„±
        let sampleInputs = '';
        const sampleSize = parseInt(spec.sampleSize) || 1;
        for (let i = 1; i <= sampleSize; i++) {
          sampleInputs += `<input type="number" step="any" class="sample-input" data-sample-index="${i-1}" placeholder="ì‹œë£Œ${i}" style="width: 80px; margin: 2px;">`;
        }

        row.innerHTML = `
          <td>${spec.inspectionItem}</td>
          <td>${spec.measurementMethod || '-'}</td>
          <td>${spec.lowerLimit || '-'}</td>
          <td>${spec.upperLimit || '-'}</td>
          <td>${sampleInputs}</td>
          <td class="pass-fail-result" style="font-weight: bold;">-</td>
        `;

        // ì¸¡ì •ê°’ ì…ë ¥ ì´ë²¤íŠ¸
        const inputs = row.querySelectorAll('.sample-input');
        inputs.forEach(function(input) {
          input.addEventListener('input', function() {
            updatePassFailResult(row, spec.lowerLimit, spec.upperLimit, sampleSize);
          });
        });

        tbody.appendChild(row);
      });
    }

    // í•©ë¶€íŒì • ìë™ ê³„ì‚°
    function updatePassFailResult(row, lowerLimit, upperLimit, sampleSize) {
      const inputs = row.querySelectorAll('.sample-input');
      const resultCell = row.querySelector('.pass-fail-result');

      let allFilled = true;
      let allPass = true;

      for (let i = 0; i < sampleSize; i++) {
        const value = parseFloat(inputs[i].value);

        if (inputs[i].value === '' || isNaN(value)) {
          allFilled = false;
          break;
        }

        // ê·œê²© ê²€ì‚¬
        const hasLower = lowerLimit && lowerLimit !== '' && lowerLimit !== '-';
        const hasUpper = upperLimit && upperLimit !== '' && upperLimit !== '-';

        if (hasLower && hasUpper) {
          // ì–‘ìª½ ê·œê²© ëª¨ë‘ ìˆëŠ” ê²½ìš°
          if (value <= parseFloat(lowerLimit) || value >= parseFloat(upperLimit)) {
            allPass = false;
          }
        } else if (hasLower) {
          // í•˜í•œë§Œ ìˆëŠ” ê²½ìš°
          if (value < parseFloat(lowerLimit)) {
            allPass = false;
          }
        } else if (hasUpper) {
          // ìƒí•œë§Œ ìˆëŠ” ê²½ìš°
          if (value > parseFloat(upperLimit)) {
            allPass = false;
          }
        }
      }

      if (!allFilled) {
        resultCell.textContent = '-';
        resultCell.style.color = '';
      } else if (allPass) {
        resultCell.textContent = 'í•©ê²©';
        resultCell.style.color = '#4caf50';
      } else {
        resultCell.textContent = 'ë¶ˆí•©ê²©';
        resultCell.style.color = '#f44336';
      }
    }

    // ê²€ì‚¬ê²°ê³¼ ì €ì¥
    function saveInspectionResults() {
      const rows = document.querySelectorAll('#inspectionItemsBody tr');
      const results = [];

      // InspectionSpecì—ì„œ ì›ë³¸ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
      google.script.run
        .withSuccessHandler(function(response) {
          if (response.success && response.data) {
            const specs = response.data;

            rows.forEach(function(row, index) {
              const spec = specs[index];
              const inputs = row.querySelectorAll('.sample-input');
              const passFailResult = row.querySelector('.pass-fail-result').textContent;

              if (passFailResult === '-') {
                alert('ëª¨ë“  ì¸¡ì •ê°’ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
              }

              const samples = [];
              inputs.forEach(function(input) {
                samples.push(input.value);
              });

              results.push({
                inspectionItem: spec.inspectionItem,
                measurementMethod: spec.measurementMethod || '',
                lowerLimit: spec.lowerLimit || '',
                upperLimit: spec.upperLimit || '',
                samples: samples,
                passFailResult: passFailResult
              });
            });

            if (results.length === rows.length) {
              // ì„œë²„ì— ì €ì¥
              google.script.run
                .withSuccessHandler(function(saveResponse) {
                  if (saveResponse.success) {
                    alert('ê²€ì‚¬ê²°ê³¼ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    closeInspectionModal();
                    loadInspectionResultKeys(function() {
                      loadData(); // ê²€ì‚¬ê²°ê³¼ í‚¤ ë¡œë“œ ì™„ë£Œ í›„ ë°ì´í„° ë¡œë“œ
                    });
                  } else {
                    alert(saveResponse.message || 'ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                  }
                })
                .withFailureHandler(function(error) {
                  console.error('ì €ì¥ ì‹¤íŒ¨:', error);
                  alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                })
                .saveInspectionResults(sessionToken, currentInspectionData.dataId, results);
            }
          }
        })
        .getInspectionSpecs(sessionToken, {
          tmNo: currentInspectionData.tmNo,
          companyName: currentInspectionData.companyName
        });
    }

    // ê²€ì‚¬ê²°ê³¼ ì¡°íšŒ (ê²€ì‚¬ì™„ë£Œ í´ë¦­ ì‹œ)
    function viewInspectionResults(dataId, companyName, tmNo, productName, date) {
      google.script.run
        .withSuccessHandler(function(response) {
          if (response.success && response.data && response.data.length > 0) {
            displayViewInspectionResults(response.data, companyName, tmNo, productName, date);
            document.getElementById('viewInspectionModal').style.display = 'block';
          } else {
            alert('ì €ì¥ëœ ê²€ì‚¬ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
          }
        })
        .withFailureHandler(function(error) {
          console.error('ê²€ì‚¬ê²°ê³¼ ì¡°íšŒ ì‹¤íŒ¨:', error);
          alert('ê²€ì‚¬ê²°ê³¼ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        })
        .getInspectionResultsByDataId(sessionToken, dataId);
    }

    // ê²€ì‚¬ê²°ê³¼ ì¡°íšŒ ê²°ê³¼ í‘œì‹œ (ì½ê¸° ì „ìš©)
    function displayViewInspectionResults(results, companyName, tmNo, productName, date) {
      const tbody = document.getElementById('viewInspectionItemsBody');
      tbody.innerHTML = '';

      document.getElementById('viewInspectionInfo').textContent =
        `${date} | ${companyName} | ${tmNo} | ${productName}`;

      results.forEach(function(result) {
        const row = document.createElement('tr');

        // ì‹œë£Œ ì¸¡ì •ê°’ í‘œì‹œ
        let sampleValues = '';
        result.samples.forEach(function(sample, index) {
          sampleValues += `<span style="margin: 0 5px;"><strong>ì‹œë£Œ${index + 1}:</strong> ${sample}</span>`;
        });

        // í•©ë¶€íŒì • ìƒ‰ìƒ
        const passFailColor = result.passFailResult === 'í•©ê²©' ? '#4caf50' : '#f44336';

        row.innerHTML = `
          <td>${result.inspectionItem}</td>
          <td>${result.measurementMethod || '-'}</td>
          <td>${result.lowerLimit || '-'}</td>
          <td>${result.upperLimit || '-'}</td>
          <td>${sampleValues}</td>
          <td style="font-weight: bold; color: ${passFailColor};">${result.passFailResult}</td>
        `;

        tbody.appendChild(row);
      });
    }

    // ê²€ì‚¬ê²°ê³¼ ì¡°íšŒ ëª¨ë‹¬ ë‹«ê¸°
    function closeViewInspectionModal() {
      document.getElementById('viewInspectionModal').style.display = 'none';
    }
  </script>

  <!-- ê²€ì‚¬ê²°ê³¼ ì…ë ¥ ëª¨ë‹¬ -->
  <div id="inspectionModal" class="modal">
    <div class="modal-content" style="max-width: 95%; max-height: 90vh;">
      <div class="modal-header">
        <h3 class="modal-title">ê²€ì‚¬ê²°ê³¼ ì…ë ¥</h3>
        <span class="close" onclick="closeInspectionModal()">&times;</span>
      </div>

      <div style="padding: 15px; background: #f5f5f5; border-bottom: 1px solid #ddd;">
        <strong id="inspectionInfo"></strong>
      </div>

      <div style="padding: 20px; overflow-y: auto; max-height: calc(90vh - 200px);">
        <table style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr style="background: #f8f9fa;">
              <th style="padding: 10px; border: 1px solid #ddd;">ê²€ì‚¬í•­ëª©</th>
              <th style="padding: 10px; border: 1px solid #ddd;">ì¸¡ì •ë°©ë²•</th>
              <th style="padding: 10px; border: 1px solid #ddd;">ê·œê²©í•˜í•œ</th>
              <th style="padding: 10px; border: 1px solid #ddd;">ê·œê²©ìƒí•œ</th>
              <th style="padding: 10px; border: 1px solid #ddd;">ì¸¡ì •ê°’ ì…ë ¥</th>
              <th style="padding: 10px; border: 1px solid #ddd;">í•©ë¶€íŒì •</th>
            </tr>
          </thead>
          <tbody id="inspectionItemsBody">
          </tbody>
        </table>
      </div>

      <div style="padding: 20px; border-top: 1px solid #e0e0e0; display: flex; justify-content: flex-end; gap: 10px;">
        <button onclick="closeInspectionModal()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer;">ì·¨ì†Œ</button>
        <button onclick="saveInspectionResults()" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer;">ì €ì¥</button>
      </div>
    </div>
  </div>

  <!-- ê²€ì‚¬ê²°ê³¼ ì¡°íšŒ ëª¨ë‹¬ (ì½ê¸° ì „ìš©) -->
  <div id="viewInspectionModal" class="modal">
    <div class="modal-content" style="max-width: 95%; max-height: 90vh;">
      <div class="modal-header">
        <h3 class="modal-title">ê²€ì‚¬ê²°ê³¼ ì¡°íšŒ</h3>
        <span class="close" onclick="closeViewInspectionModal()">&times;</span>
      </div>

      <div style="padding: 15px; background: #f5f5f5; border-bottom: 1px solid #ddd;">
        <strong id="viewInspectionInfo"></strong>
      </div>

      <div style="padding: 20px; overflow-y: auto; max-height: calc(90vh - 200px);">
        <table style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr style="background: #f8f9fa;">
              <th style="padding: 10px; border: 1px solid #ddd;">ê²€ì‚¬í•­ëª©</th>
              <th style="padding: 10px; border: 1px solid #ddd;">ì¸¡ì •ë°©ë²•</th>
              <th style="padding: 10px; border: 1px solid #ddd;">ê·œê²©í•˜í•œ</th>
              <th style="padding: 10px; border: 1px solid #ddd;">ê·œê²©ìƒí•œ</th>
              <th style="padding: 10px; border: 1px solid #ddd;">ì¸¡ì •ê°’</th>
              <th style="padding: 10px; border: 1px solid #ddd;">í•©ë¶€íŒì •</th>
            </tr>
          </thead>
          <tbody id="viewInspectionItemsBody">
          </tbody>
        </table>
      </div>

      <div style="padding: 20px; border-top: 1px solid #e0e0e0; display: flex; justify-content: flex-end; gap: 10px;">
        <button onclick="closeViewInspectionModal()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer;">ë‹«ê¸°</button>
      </div>
    </div>
  </div>
</body>
</html>
